# pgpool-II configuration file - Managed by Confd from etcd
# This file is automatically generated. DO NOT EDIT MANUALLY.
#
# This configuration provides:
# - Connection pooling with transaction mode
# - Automatic read/write splitting
# - LOCAL ONLY reads when local database is healthy
# - Automatic failover to remote databases only when local is down
#

#------------------------------------------------------------------------------
# NETWORK CONFIGURATION
#------------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
socket_dir = '/run/postgresql'
pcp_listen_addresses = '*'
pcp_port = 9898
pcp_socket_dir = '/run/postgresql'
pid_file_name = '/run/pgpool/pgpool.pid'

#------------------------------------------------------------------------------
# CONNECTION POOLING
#------------------------------------------------------------------------------
pool_mode = 'transaction'
num_init_children = 32
max_pool = 4
connection_life_time = 0
client_idle_limit = 0
child_life_time = 300
child_max_connections = 0

#------------------------------------------------------------------------------
# AUTHENTICATION
#------------------------------------------------------------------------------
enable_pool_hba = on
pool_passwd = 'pool_passwd'
authentication_timeout = 60
allow_clear_text_frontend_auth = off

#------------------------------------------------------------------------------
# LOAD BALANCING AND QUERY ROUTING
#------------------------------------------------------------------------------
load_balance_mode = on
ignore_leading_white_space = on
white_function_list = ''
black_function_list = 'currval,lastval,nextval,setval'
black_query_pattern_list = 'INSERT;UPDATE;DELETE;TRUNCATE;ALTER;CREATE;DROP;GRANT;REVOKE'
disable_load_balance_on_write = 'transaction'
statement_level_load_balance = on

#------------------------------------------------------------------------------
# STREAMING REPLICATION MODE
#------------------------------------------------------------------------------
master_slave_mode = on
master_slave_sub_mode = 'stream'
sr_check_period = 10
sr_check_user = 'proposalsapp'
sr_check_password = '{{getv "/pgcat/password" ""}}'
sr_check_database = 'proposalsapp'
delay_threshold = 10000000

#------------------------------------------------------------------------------
# HEALTH CHECK
#------------------------------------------------------------------------------
health_check_period = 30
health_check_timeout = 10
health_check_user = 'proposalsapp'
health_check_password = '{{getv "/pgcat/password" ""}}'
health_check_database = 'proposalsapp'
health_check_max_retries = 3
health_check_retry_delay = 1
connect_timeout = 10000

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------
log_destination = 'stderr'
log_line_prefix = '%t [%p] %q%u@%d '
log_connections = off
log_disconnections = off
log_hostname = off
log_statement = none
log_per_node_statement = off
log_client_messages = off
log_standby_delay = 'if_over_threshold'
debug_level = 0

#------------------------------------------------------------------------------
# PCP SETTINGS
#------------------------------------------------------------------------------
pcp_user = 'pgpool'
pcp_password = 'changeme'

#------------------------------------------------------------------------------
# WATCHDOG (Disabled)
#------------------------------------------------------------------------------
use_watchdog = off

#------------------------------------------------------------------------------
# MEMORY CACHE - Disabled to avoid lock file issues
#------------------------------------------------------------------------------
memory_cache_enabled = off
enable_query_cache = off
memqcache_method = 'shmem'
memqcache_memcached_host = ''
memqcache_memcached_port = 11211
memqcache_total_size = 64MB
memqcache_max_num_cache = 1000000
memqcache_expire = 0
memqcache_cache_block_size = 1MB
memqcache_oiddir = '/tmp'
memqcache_auto_cache_invalidation = off
# Set logdir to a writable location
logdir = '/var/log/pgpool2'

#------------------------------------------------------------------------------
# MISC CONFIGURATION
#------------------------------------------------------------------------------
relcache_expire = 0
relcache_size = 256
process_management_mode = static
process_management_strategy = gentle
insert_lock = off
lobj_lock_table = ''
connection_cache = on
reset_query_list = 'ABORT; DISCARD ALL'
failover_on_backend_error = off
failover_on_backend_shutdown = off

#------------------------------------------------------------------------------
# BACKEND SERVERS - LOCAL FIRST CONFIGURATION
#------------------------------------------------------------------------------
# Strategy: Weight-based load balancing with fallback capability
# - Local database gets weight 100
# - Remote databases get weight 1 (allows fallback when local is down)
# This ensures 99% of reads go to local database when healthy
# but allows automatic fallback to remote databases if local fails
{{$local_dc := getenv "LOCAL_DATACENTER"}}

# Backend 0 - db-sib-01
backend_hostname0 = '{{getv "/local/ips/dc1" ""}}'
backend_port0 = 5432
# Weight strategy: Strong preference for local reads with fallback capability
# Local backend gets weight 100, remote backends get weight 1 (not 0)
# This ensures remote backends CAN be used if local is down
{{if eq $local_dc "dc1"}}
backend_weight0 = 100
{{else}}
backend_weight0 = 1
{{end}}
backend_data_directory0 = '/var/lib/postgresql/17/main'
backend_flag0 = 'ALLOW_TO_FAILOVER'
backend_application_name0 = 'pgpool_dc1'

# Backend 1 - db-sib-02
backend_hostname1 = '{{getv "/local/ips/dc2" ""}}'
backend_port1 = 5432
{{if eq $local_dc "dc2"}}
backend_weight1 = 100
{{else}}
backend_weight1 = 1
{{end}}
backend_data_directory1 = '/var/lib/postgresql/17/main'
backend_flag1 = 'ALLOW_TO_FAILOVER'
backend_application_name1 = 'pgpool_dc2'

# Backend 2 - db-sib-03
backend_hostname2 = '{{getv "/local/ips/dc3" ""}}'
backend_port2 = 5432
{{if eq $local_dc "dc3"}}
backend_weight2 = 100
{{else}}
backend_weight2 = 1
{{end}}
backend_data_directory2 = '/var/lib/postgresql/17/main'
backend_flag2 = 'ALLOW_TO_FAILOVER'
backend_application_name2 = 'pgpool_dc3'