# pgpool-II configuration file - Managed by Confd from etcd
# This file is automatically generated. DO NOT EDIT MANUALLY.

#------------------------------------------------------------------------------
# NETWORK CONFIGURATION
#------------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
socket_dir = '/var/run/pgpool'
pcp_listen_addresses = '*'
pcp_port = 9898
pcp_socket_dir = '/var/run/pgpool'

#------------------------------------------------------------------------------
# CONNECTION POOLING
#------------------------------------------------------------------------------
pool_mode = 'transaction'
num_init_children = 32
max_pool = 4
connection_life_time = 0
client_idle_limit = 0
child_life_time = 300
child_max_connections = 0

#------------------------------------------------------------------------------
# AUTHENTICATION
#------------------------------------------------------------------------------
enable_pool_hba = on
pool_passwd = 'pool_passwd'
authentication_timeout = 60
allow_clear_text_frontend_auth = off

#------------------------------------------------------------------------------
# LOAD BALANCING AND QUERY ROUTING
#------------------------------------------------------------------------------
load_balance_mode = on
ignore_leading_white_space = on
white_function_list = ''
black_function_list = 'currval,lastval,nextval,setval'
black_query_pattern_list = 'INSERT;UPDATE;DELETE;TRUNCATE;ALTER;CREATE;DROP;GRANT;REVOKE'
disable_load_balance_on_write = 'transaction'
statement_level_load_balance = on

#------------------------------------------------------------------------------
# STREAMING REPLICATION MODE
#------------------------------------------------------------------------------
master_slave_mode = on
master_slave_sub_mode = 'stream'
sr_check_period = 10
sr_check_user = 'proposalsapp'
sr_check_password = '{{getv "/pgcat/password" ""}}'
sr_check_database = 'proposalsapp'
delay_threshold = 10000000

#------------------------------------------------------------------------------
# HEALTH CHECK
#------------------------------------------------------------------------------
health_check_period = 30
health_check_timeout = 10
health_check_user = 'proposalsapp'
health_check_password = '{{getv "/pgcat/password" ""}}'
health_check_database = 'proposalsapp'
health_check_max_retries = 3
health_check_retry_delay = 1
connect_timeout = 10000

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------
log_destination = 'stderr'
log_line_prefix = '%t [%p] %q%u@%d '
log_connections = off
log_disconnections = off
log_hostname = off
log_statement = none
log_per_node_statement = off
log_client_messages = off
log_standby_delay = 'if_over_threshold'
debug_level = 0

#------------------------------------------------------------------------------
# PCP SETTINGS
#------------------------------------------------------------------------------
pcp_user = 'pgpool'
pcp_password = 'changeme'

#------------------------------------------------------------------------------
# WATCHDOG (Disabled)
#------------------------------------------------------------------------------
use_watchdog = off

#------------------------------------------------------------------------------
# MEMORY CACHE
#------------------------------------------------------------------------------
memory_cache_enabled = off
memqcache_method = 'shmem'
memqcache_memcached_host = ''
memqcache_memcached_port = 11211
memqcache_total_size = 64MB
memqcache_max_num_cache = 1000000
memqcache_expire = 0
memqcache_cache_block_size = 1MB

#------------------------------------------------------------------------------
# MISC CONFIGURATION
#------------------------------------------------------------------------------
relcache_expire = 0
relcache_size = 256
process_management_mode = static
process_management_strategy = gentle
insert_lock = off
lobj_lock_table = ''
connection_cache = on
reset_query_list = 'ABORT; DISCARD ALL'
failover_on_backend_error = off
failover_on_backend_shutdown = off

#------------------------------------------------------------------------------
# BACKEND SERVERS (Dynamically configured from Patroni state in etcd)
#------------------------------------------------------------------------------
# Backend 0
{{$local_dc := getv "/local/datacenter"}}
{{$local_ip := getv (printf "/local/ips/%s" $local_dc) ""}}
{{range gets "/service/proposalsapp/members/*"}}
{{$member := json .Value}}
{{if eq $member.state "running"}}
    {{$url_parts := split $member.conn_url "//"}}
    {{if gt (len $url_parts) 1}}
        {{$host_port := index (split (index $url_parts 1) "/") 0}}
        {{$host := index (split $host_port ":") 0}}
        {{$port := index (split $host_port ":") 1}}
        {{if eq $host $local_ip}}
# Local {{$member.role}} in {{$local_dc}}
backend_hostname0 = '{{$host}}'
backend_port0 = {{$port}}
backend_weight0 = 2
backend_data_directory0 = '/var/lib/postgresql/17/main'
backend_flag0 = 'ALLOW_TO_FAILOVER'
backend_application_name0 = 'pgpool_{{$local_dc}}'
        {{end}}
    {{end}}
{{end}}
{{end}}

# Backend 1 and 2 - Remote servers
{{$backend_num := 1}}
{{range gets "/service/proposalsapp/members/*"}}
{{$member := json .Value}}
{{if eq $member.state "running"}}
    {{$url_parts := split $member.conn_url "//"}}
    {{if gt (len $url_parts) 1}}
        {{$host_port := index (split (index $url_parts 1) "/") 0}}
        {{$host := index (split $host_port ":") 0}}
        {{$port := index (split $host_port ":") 1}}
        {{if ne $host $local_ip}}
{{if eq $backend_num 1}}
# Remote {{$member.role}}
backend_hostname1 = '{{$host}}'
backend_port1 = {{$port}}
backend_weight1 = 1
backend_data_directory1 = '/var/lib/postgresql/17/main'
backend_flag1 = 'ALLOW_TO_FAILOVER'
backend_application_name1 = 'pgpool_remote'
{{else if eq $backend_num 2}}
# Remote {{$member.role}}
backend_hostname2 = '{{$host}}'
backend_port2 = {{$port}}
backend_weight2 = 1
backend_data_directory2 = '/var/lib/postgresql/17/main'
backend_flag2 = 'ALLOW_TO_FAILOVER'
backend_application_name2 = 'pgpool_remote'
{{end}}
        {{end}}
    {{end}}
{{end}}
{{end}}