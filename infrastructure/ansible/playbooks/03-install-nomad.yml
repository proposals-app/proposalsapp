---
- name: Install and Configure Nomad Servers
  hosts: nomad_servers
  become: true
  tasks:
    - name: Set connection to use tailscale IP if available
      set_fact:
        ansible_host: "{{ tailscale_ip }}"
      when: tailscale_ip is defined and tailscale_ip != ''
    - name: Install Nomad
      apt:
        name: nomad
        state: present

    - name: Create Nomad server configuration
      template:
        src: ../templates/nomad-server.hcl.j2
        dest: /etc/nomad.d/nomad.hcl
        owner: nomad
        group: nomad
        mode: "0640"
      notify: restart nomad

    - name: Create systemd override directory for Nomad
      file:
        path: /etc/systemd/system/nomad.service.d
        state: directory
        mode: "0755"

    - name: Create Nomad systemd service override
      copy:
        content: |
          [Service]
          Environment="CONSUL_HTTP_ADDR=http://127.0.0.1:{{ consul_client_port }}"
        dest: /etc/systemd/system/nomad.service.d/override.conf
      notify:
        - reload systemd
        - restart nomad

    - name: Start and enable Nomad
      systemd:
        name: nomad
        state: started
        enabled: yes
        daemon_reload: yes

    - name: Wait for Nomad to be ready
      wait_for:
        port: "{{ nomad_http_port }}"
        delay: 5

    - name: Wait for leader election
      shell: |
        if [ "{{ nomad_acl_enabled | default(false) | string | lower }}" = "true" ] && [ ! -f /root/nomad-bootstrap.json ]; then
          # When ACLs enabled but not bootstrapped, use server members (doesn't require token)
          nomad server members | grep -q "alive.*leader"
        else
          # When ACLs disabled or already bootstrapped
          nomad operator raft list-peers | grep -q "leader=true"
        fi
      register: leader_check
      until: leader_check.rc == 0
      retries: 10
      delay: 5
      run_once: true
      changed_when: false

    # ACL bootstrap moved to separate playbook (02a-bootstrap-acls.yml)
    # This ensures services are running before attempting ACL operations

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes

    - name: restart nomad
      systemd:
        name: nomad
        state: restarted

- name: Install and Configure Nomad Clients
  hosts: nomad_clients
  become: true
  tasks:
    - name: Set connection to use tailscale IP if available
      set_fact:
        ansible_host: "{{ tailscale_ip }}"
      when: tailscale_ip is defined and tailscale_ip != ''
    - name: Install Nomad
      apt:
        name: nomad
        state: present

    - name: Install Docker
      apt:
        name:
          - docker.io
          - docker-compose
        state: present

    - name: Add nomad user to docker group
      user:
        name: nomad
        groups: docker
        append: yes

    - name: Create Nomad client configuration
      template:
        src: ../templates/nomad-client.hcl.j2
        dest: /etc/nomad.d/nomad.hcl
        owner: nomad
        group: nomad
        mode: "0640"
      notify: restart nomad

    - name: Create Docker daemon configuration
      copy:
        content: |
          {
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3"
            },
            "storage-driver": "overlay2",
            "metrics-addr": "127.0.0.1:9323",
            "experimental": true
          }
        dest: /etc/docker/daemon.json
      notify: restart docker

    - name: Start and enable services
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - docker
        - nomad

  handlers:
    - name: restart nomad
      systemd:
        name: nomad
        state: restarted

    - name: restart docker
      systemd:
        name: docker
        state: restarted
