# Consul-replicate configuration for Patroni DCS replication
# This ensures Patroni's distributed configuration is synchronized across all datacenters

consul {
  address = "127.0.0.1:{{ consul_client_port }}"
  token = "{{ consul_token | default('') }}"
  
  # Retry configuration
  retry {
    enabled = true
    attempts = 12
    backoff = "250ms"
    max_backoff = "1m"
  }
}

# Logging configuration
log_level = "info"
syslog {
  enabled = true
}

# Replication strategy: Each DC pulls from the DC where the Patroni leader is
# This is determined dynamically based on the leader key in Consul

# For now, we'll use a simpler approach: replicate from all other DCs
# This ensures we get the latest state regardless of where writes happen

{% if datacenter == 'dc1' %}
# DC1 pulls from DC2 and DC3
prefix {
  source = "service/proposalsapp"
  datacenter = "dc2"
  destination = "service/proposalsapp"
}

prefix {
  source = "service/proposalsapp"
  datacenter = "dc3"
  destination = "service/proposalsapp"
}
{% elif datacenter == 'dc2' %}
# DC2 pulls from DC1 and DC3
prefix {
  source = "service/proposalsapp"
  datacenter = "dc1"
  destination = "service/proposalsapp"
}

prefix {
  source = "service/proposalsapp"
  datacenter = "dc3"
  destination = "service/proposalsapp"
}
{% elif datacenter == 'dc3' %}
# DC3 pulls from DC1 and DC2
prefix {
  source = "service/proposalsapp"
  datacenter = "dc1"
  destination = "service/proposalsapp"
}

prefix {
  source = "service/proposalsapp"
  datacenter = "dc2"
  destination = "service/proposalsapp"
}
{% endif %}