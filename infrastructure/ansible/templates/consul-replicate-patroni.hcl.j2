# Enhanced Consul-replicate configuration for Patroni with bidirectional sync
# This configuration ensures all Patroni nodes are visible across all datacenters

consul {
  address = "127.0.0.1:{{ consul_client_port }}"
  token = "{{ consul_token | default('') }}"
  
  retry {
    enabled = true
    attempts = 12
    backoff = "250ms"
    max_backoff = "1m"
  }
}

log_level = "info"
syslog {
  enabled = true
}

# Bidirectional replication for Patroni data
# Each datacenter both pushes and pulls to ensure consistency

{% for dc in ['dc1', 'dc2', 'dc3'] %}
{% if dc != datacenter %}
# Pull from {{ dc }} to local datacenter
prefix {
  source = "service/proposalsapp"
  datacenter = "{{ dc }}"
  destination = "service/proposalsapp/{{ dc }}"
  # This creates a namespaced copy for reference
}

# Also maintain a merged view
prefix {
  source = "service/proposalsapp/members"
  datacenter = "{{ dc }}"
  destination = "service/proposalsapp/members"
  # Don't overwrite existing keys
  mode = "merge"
}
{% endif %}
{% endfor %}

# Additionally sync the entire service tree for better visibility
prefix {
  source = "service"
  datacenter = "{{ 'dc1' if datacenter != 'dc1' else 'dc2' }}"
  destination = "service"
  # Only sync proposalsapp related keys
  include = ["proposalsapp/*"]
}